# 6.2 置信区间 (Confidence Intervals)：侦探的“误差带”工具包

在掌握了中心极限定理后，我们获得了从样本推断总体的强大理论基础。现在，让我们来学习一个核心的推断工具——**置信区间 **(CI)。

### 6.2.1 什么是置信区间？

想象你正在调查一个案件，需要估算“城市中成年人的平均身高”。你测量了100个人，得到平均身高是175cm。

*   **点估计**: 175cm 是你对“真实平均身高”的一个猜测。但它只是一个点，你无法评估其精确度。
*   **置信区间 **(CI) 这就像给你的点估计加上一个**误差带**。它提供了一个范围，比如 [173cm, 177cm]，并附带一个“可信度”——例如，95%置信区间。

**95%置信区间的含义**：如果你用完全相同的方法重复抽样100次，每次都计算一个95%的置信区间，那么大约有95个区间会包含真实的总体均值，而大约有5个区间不会包含它。对于任何一个特定的区间，真实均值要么在里面，要么不在。

### 6.2.2 核心公式与要素

置信区间的计算遵循统一公式：

**置信区间 = 点估计 ± (临界值 * 标准误差)**

*   **点估计**: 你要估计的总体参数的样本估计值，如样本均值 $\bar{x}$ 或样本比例 $\hat{p}$。
*   **临界值 **(Critical Value) 取决于你选择的**置信水平 **(CL)。对于估计均值，且样本量较大时，使用Z分布。
    *   90% CL -> Z* ≈ 1.645
    *   95% CL -> Z* ≈ 1.96
    *   99% CL -> Z* ≈ 2.576
*   **标准误差 **(SE) 衡量点估计的变异性。
    *   估计**总体均值**: $SE = \frac{s}{\sqrt{n}}$ (s为样本标准差, n为样本量) 或 $SE = \frac{\sigma}{\sqrt{n}}$ (σ为已知的总体标准差)。
    *   估计**总体比例**: $SE = \sqrt{\frac{\hat{p}(1-\hat{p})}{n}}$。

#### 关键概念：误差范围 (Margin of Error, MOE)

**误差范围**是公式中 `临界值 * 标准误差` 这一部分。它定义了置信区间的"宽度"。
$$MOE = \text{临界值} \times SE$$
置信区间也可以写成: `点估计 ± MOE`

*   **MOE 越大**：区间越宽，估计越不精确，但信心越高。
*   **MOE 越小**：区间越窄，估计越精确，但信心相对降低。

**影响 MOE 的因素**:

1.  **置信水平 **(CL) CL 越高 (如从 95% 提升到 99%)，临界值越大，MOE 越大。
2.  **标准误差 **(SE) SE 受以下因素影响：
    *   **数据变异性 **(s 或 σ) 数据越分散，SE 和 MOE 越大。
    *   **样本量 **(n) 样本量越大，SE 越小 ($SE \propto \frac{1}{\sqrt{n}}$)，MOE 越小。这是提高估计精确度最直接的方法。

**详细公式 - 误差范围的精确表达**:

根据Kozak教材，误差范围的计算公式有具体的表达形式，取决于我们要估计的参数类型：

*   **估计总体均值 (σ已知)**: $E = z_{\\alpha/2} \cdot \frac{\\sigma}{\\sqrt{n}}$
*   **估计总体均值 (σ未知)**: $E = t_{\\alpha/2} \cdot \frac{s}{\\sqrt{n}}$
*   **估计总体比例**: $E = z_{\\alpha/2} \cdot \sqrt{\frac{\\hat{p}(1-\\hat{p})}{n}}$

其中 $\\alpha = 1 - C$（C是置信水平），临界值为 $z_{\\alpha/2}$ 或 $t_{\\alpha/2}$。

**生动示例：误差范围的影响因素**

想象你是一名市场调研员，想估算某款新产品的用户满意度比例 (p)：

1. **置信水平的影响**：
   *   90%置信水平：$z_{\\alpha/2} = 1.645$ → 误差范围较窄
   *   95%置信水平：$z_{\\alpha/2} = 1.96$ → 误差范围适中
   *   99%置信水平：$z_{\\alpha/2} = 2.576$ → 误差范围较宽
   *   *比喻*：就像用不同精度的尺子测量，精度越高（置信水平越高），测量范围越宽以确保包含真实值。
   
   **可视化表示**：
   ```
   90% 置信区间: |--------| (较窄，信心较低)
   95% 置信区间: |----------| (适中)
   99% 置信区间: |------------| (较宽，信心最高)
                  ↑
              真实参数值（未知位置）
   ```

2. **样本量的影响**：
   *   $n=100$：$SE = \sqrt{\frac{0.5(1-0.5)}{100}} = 0.05$ → $E = 1.96 \times 0.05 = 0.098$
   *   $n=400$：$SE = \sqrt{\frac{0.5(1-0.5)}{400}} = 0.025$ → $E = 1.96 \times 0.025 = 0.049$
   *   *比喻*：就像用放大镜看细节，样本量越大，看到的越清晰（误差越小）。
   
   **可视化表示**：
   ```
   小样本 (n=100): |------------------| (误差范围大，不够精确)
   
   大样本 (n=400): |--------| (误差范围小，更精确)
                   ↑
               真实参数值（更可能被包含）
   ```

### 6.2.3 实际案例：估算平均身高

> **情景**: 你调查了 100 人，样本均值 $\bar{x} = 175$ cm，样本标准差 $s = 10$ cm。

1.  **计算 95% 置信区间**:
    *   $Z^* = 1.96$
    *   $SE = s / \sqrt{n} = 10 / \sqrt{100} = 10 / 10 = 1$
    *   $MOE = 1.96 \times 1 = 1.96$
    *   $CI = 175 \pm 1.96 = [173.04, 176.96]$
    *   **解读**: 我们有95%的信心认为，城市成年人的真实平均身高在173.04cm到176.96cm之间。

2.  **比较不同置信水平**:
    *   **90% CL**: $Z^* \approx 1.645$, $MOE = 1.645 \times 1 = 1.645$, $CI = [173.36, 176.64]$ (更窄)
    *   **99% CL**: $Z^* \approx 2.576$, $MOE = 2.576 \times 1 = 2.576$, $CI = [172.42, 177.58]$ (更宽)

### 6.2.4 确定所需样本量 (n)

在进行研究前，你可能希望预先设定一个"希望达到的估计精确度"，即**希望的误差范围 **($E_{max}$)。你可以据此计算出**最小**样本量。

**求解样本量 n 的公式**:
从 $E = Z^* \times \frac{\sigma}{\sqrt{n}}$ 推导而来。如果 $\sigma$ 未知，用一个预估的标准差 $s$ 代替。
$$n = \left(\frac{Z^* \times s}{E_{max}}\right)^2$$

> **注**: $E_{max}$ 为最大允许误差（即希望达到的误差范围）。

> **关键**: **先**确定你想要的置信水平（确定 Z*）和希望的 MOE，**再**估算或预估标准差 s，就可以算出 n。

#### 案例：规划样本量

> **情景**: 在进行上述身高调查前，你希望在95%置信水平下，误差范围 (MOE) 不超过 1 cm。根据过往经验，预估身高标准差 $\sigma \approx 10$ cm。

*   $Z^* = 1.96$ (95% CL)
*   $E_{max} = 1$ cm
*   $s = 10$ cm
*   $n = \left(\frac{1.96 \times 10}{1}\right)^2 = (19.6)^2 = 384.16$

**结论**: 你需要至少 **385** 人（向上取整）的样本量才能满足要求。

**Kozak教材中的完整样本量公式**:

根据Kozak教材，样本量的计算公式具体形式取决于要估计的参数类型：

*   **估计总体均值**: $n = \left(\frac{z_{\\alpha/2} \\sigma}{E}\right)^2$
*   **估计总体比例**: $n = \frac{(z_{\\alpha/2})^2 \\hat{p}(1-\\hat{p})}{E^2}$

其中 $E$ 是希望的误差范围，当 $\hat{p}$ 未知时，使用 $\hat{p} = 0.5$ 以获得最大样本量（最保守的估计）。

**生动示例：民意调查中的样本量计算**

> **情景**: 你想进行一项民意调查，了解市民对某项政策的支持率。你希望在95%置信水平下，误差范围不超过3% (0.03)。

*   **方法1**（比例未知）：当对比例 $\hat{p}$ 一无所知时，使用最保守的估计 $\hat{p} = 0.5$
    *   $z_{\\alpha/2} = 1.96$ (95%置信水平)
    *   $E = 0.03$
    *   $n = \frac{1.96^2 \times 0.5 \times (1-0.5)}{0.03^2} = \frac{3.8416 \times 0.25}{0.0009} = \frac{0.9604}{0.0009} = 1067.11$
    
    **结论**: 你需要至少 **1068** 人的样本量（向上取整）才能满足要求。

*   **方法2**（已有预估）：如果你通过预调研知道大约60%的市民支持（$\hat{p} = 0.6$）
    *   $n = \frac{1.96^2 \times 0.6 \times (1-0.6)}{0.03^2} = \frac{3.8416 \times 0.24}{0.0009} = \frac{0.9220}{0.0009} = 1024.44$
    
    **结论**: 在已知预估比例的情况下，你只需要至少 **1025** 人的样本量。

*   **比喻**: 确定样本量就像决定用多少精度的镜头来拍摄照片。精度要求越高（误差范围越小），需要的样本量（像素）就越大。当对目标一无所知时，我们选择最保守的设置（$\hat{p} = 0.5$），确保在最坏情况下也能满足精度要求。
   
   **可视化表示 - 样本量与精度的关系**：
   ```
   高精度需求 (E=0.01): 需要大样本量 n=9604
   中等精度需求 (E=0.03): 需要中等样本量 n=1068  
   低精度需求 (E=0.05): 需要较小样本量 n=385
   
   | 精度需求越低 → | ← 精度需求越高 |
        n=385        n=1068       n=9604
   ```

### 6.2.5 置信区间与 p-value 的关系

在假设检验（如 t 检验）中，如果 p-value < 0.05 (在 α=0.05 的显著性水平下)，我们**拒绝**原假设（比如 $H_0: \mu = \mu_0$）。这与 **95% 置信区间**不包含原假设的值（$\mu_0$）**是等价的**。

*   p-value < 0.05 → 拒绝 $H_0: \mu = \mu_0$ → 95% CI **不包含** $\mu_0$
*   p-value ≥ 0.05 → 不拒绝 $H_0: \mu = \mu_0$ → 95% CI **包含** $\mu_0$

两者是看待同一统计结论的不同方式。

### 6.2.6 R代码实现：置信区间、误差范围与样本量计算

以下是使用R语言实现本章关键统计计算的核心代码：

#### 1. 置信区间计算

**均值的置信区间（σ已知）：**
```r
# 均值的置信区间（总体标准差已知）
# 示例：身高调查，n=100, 样本均值=175, 总体标准差=10, 95%置信水平
n <- 100
x_bar <- 175  # 样本均值
sigma <- 10   # 总体标准差
conf_level <- 0.95

# 计算临界值
alpha <- 1 - conf_level
z_star <- qnorm(1 - alpha/2)

# 标准误差
SE <- sigma / sqrt(n)

# 误差范围
MOE <- z_star * SE

# 置信区间
CI_lower <- x_bar - MOE
CI_upper <- x_bar + MOE

cat("95%置信区间: [", CI_lower, ",", CI_upper, "]\n")
# 输出: 95%置信区间: [ 173.04 , 176.96 ]
```

**均值的置信区间（σ未知）：**
```r
# 均值的置信区间（总体标准差未知，使用t分布）
# 示例：小样本数据
data <- c(170, 172, 175, 178, 180, 168, 174, 176, 179, 171)  # n=10的小样本
n <- length(data)
x_bar <- mean(data)
s <- sd(data)  # 样本标准差
conf_level <- 0.95

# 计算临界值 (使用t分布)
alpha <- 1 - conf_level
t_star <- qt(1 - alpha/2, df = n-1)

# 标准误差
SE <- s / sqrt(n)

# 误差范围
MOE <- t_star * SE

# 置信区间
CI_lower <- x_bar - MOE
CI_upper <- x_bar + MOE

cat("样本均值:", x_bar, "\n")
cat("样本标准差:", s, "\n")
cat("95% t置信区间: [", CI_lower, ",", CI_upper, "]\n")

# 或者使用R内置函数
t.test(data, conf.level = conf_level)
```

**比例的置信区间：**
```r
# 比例的置信区间
# 示例：1000人中有520人支持某政策，估计支持率
n <- 1000
x <- 520  # 成功次数
p_hat <- x/n  # 样本比例
conf_level <- 0.95

# 正态近似法 (Wilson Score Interval更精确，但此处展示基本方法)
alpha <- 1 - conf_level
z_star <- qnorm(1 - alpha/2)

# 标准误差
SE <- sqrt(p_hat * (1 - p_hat) / n)

# 误差范围
MOE <- z_star * SE

# 置信区间
CI_lower <- p_hat - MOE
CI_upper <- p_hat + MOE

cat("样本比例:", p_hat, "\n")
cat("95%置信区间: [", CI_lower, ",", CI_upper, "]\n")

# 或者使用R内置函数 (更精确的方法)
prop.test(x, n, conf.level = conf_level, correct = FALSE)
```

#### 2. 误差范围计算

**各种情况下的误差范围：**
```r
# 计算不同情况下的误差范围
# 均值 (σ已知)
calculate_MOE_mean_known <- function(sigma, n, conf_level = 0.95) {
  alpha <- 1 - conf_level
  z_star <- qnorm(1 - alpha/2)
  SE <- sigma / sqrt(n)
  MOE <- z_star * SE
  return(MOE)
}

# 均值 (σ未知)
calculate_MOE_mean_unknown <- function(s, n, conf_level = 0.95) {
  alpha <- 1 - conf_level
  t_star <- qt(1 - alpha/2, df = n-1)
  SE <- s / sqrt(n)
  MOE <- t_star * SE
  return(MOE)
}

# 比例
calculate_MOE_prop <- function(p_hat, n, conf_level = 0.95) {
  alpha <- 1 - conf_level
  z_star <- qnorm(1 - alpha/2)
  SE <- sqrt(p_hat * (1 - p_hat) / n)
  MOE <- z_star * SE
  return(MOE)
}

# 示例使用
cat("误差范围示例:\n")
cat("均值(σ=10, n=100):", calculate_MOE_mean_known(10, 100), "\n")
cat("均值(s=10, n=25):", calculate_MOE_mean_unknown(10, 25), "\n")
cat("比例(p=0.5, n=400):", calculate_MOE_prop(0.5, 400), "\n")
```

#### 3. 所需样本量计算

**估计均值所需的样本量：**
```r
# 估计均值所需的样本量 (σ已知)
sample_size_mean <- function(sigma, MOE_wanted, conf_level = 0.95) {
  alpha <- 1 - conf_level
  z_star <- qnorm(1 - alpha/2)
  n <- (z_star * sigma / MOE_wanted)^2
  return(ceiling(n))  # 向上取整
}

# 示例：身高调查，σ=10cm，希望E≤1cm，95%置信水平
n_needed <- sample_size_mean(sigma = 10, MOE_wanted = 1, conf_level = 0.95)  # 注意：函数中仍使用MOE_wanted作为参数名
cat("所需样本量:", n_needed, "\n")
```

**估计比例所需的样本量：**
```r
# 估计比例所需的样本量
sample_size_prop <- function(p_hat = 0.5, MOE_wanted, conf_level = 0.95) {
  alpha <- 1 - conf_level
  z_star <- qnorm(1 - alpha/2)
  n <- (z_star^2 * p_hat * (1 - p_hat)) / MOE_wanted^2
  return(ceiling(n))  # 向上取整
}

# 示例1：比例未知，使用p=0.5（最保守估计）
n_needed1 <- sample_size_prop(p_hat = 0.5, MOE_wanted = 0.03, conf_level = 0.95)  # 注意：函数中仍使用MOE_wanted作为参数名
cat("比例未知（保守）所需样本量:", n_needed1, "\n")

# 示例2：已知预估p=0.6
n_needed2 <- sample_size_prop(p_hat = 0.6, MOE_wanted = 0.03, conf_level = 0.95)  # 注意：函数中仍使用MOE_wanted作为参数名
cat("已知p=0.6所需样本量:", n_needed2, "\n")
```